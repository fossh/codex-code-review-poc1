name: dev-codex-cli-review

on:
  pull_request:
    branches: [dev]
    types: [opened, reopened, synchronize]
  pull_request_target:
    branches: [dev]
    types: [opened, reopened, synchronize]
  push:
    branches:
      - e2e-codex-review-*
  workflow_dispatch:
    inputs:
      pr_number:
        description: Pull request number to review
        required: true
        type: string

jobs:
  codex-cli:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: run-codex-review
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON || vars.CODEX_AUTH_JSON }}
          CODEX_ID_RSA: ${{ secrets.CODEX_ID_RSA || vars.CODEX_ID_RSA }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID || vars.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY || vars.AWS_SECRET_ACCESS_KEY }}
          CODEX_EXISTING_INSTANCE_ID: ${{ secrets.CODEX_EXISTING_INSTANCE_ID || vars.CODEX_EXISTING_INSTANCE_ID }}
          PR_NUMBER: ${{ github.event.inputs.pr_number || '' }}
          SESSION_NAME: codex-${{ github.event.repository.name }}-${{ github.run_id }}
        run: |
          set -euo pipefail

          # Write secrets to temp files
          mkdir -p /tmp/codex
          echo "$GITHUB_CONTEXT" > /tmp/codex/github_context.json
          echo "$GITHUB_TOKEN" > /tmp/codex/github_token.txt
          echo "$CODEX_AUTH_JSON" > /tmp/codex/auth.json
          echo "$CODEX_ID_RSA" > /tmp/codex/id_rsa
          chmod 600 /tmp/codex/id_rsa

          # Get EC2 public IP
          export AWS_DEFAULT_REGION=ap-south-1
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids "$CODEX_EXISTING_INSTANCE_ID" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "EC2 IP: $PUBLIC_IP"

          # SSH options
          SSH_OPTS="-i /tmp/codex/id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=15 -o LogLevel=ERROR"
          SSH_USER="ubuntu"
          REMOTE_WORKDIR="/home/$SSH_USER/codex-work/$SESSION_NAME"

          # Wait for SSH
          for i in {1..30}; do
            ssh $SSH_OPTS "$SSH_USER@$PUBLIC_IP" "echo ready" && break || sleep 5
          done

          # Create remote dirs and upload files
          ssh $SSH_OPTS "$SSH_USER@$PUBLIC_IP" "mkdir -p ~/.codex $REMOTE_WORKDIR/.github/tmp"
          scp $SSH_OPTS /tmp/codex/auth.json "$SSH_USER@$PUBLIC_IP:~/.codex/auth.json"
          scp $SSH_OPTS /tmp/codex/github_context.json "$SSH_USER@$PUBLIC_IP:$REMOTE_WORKDIR/.github/tmp/"
          scp $SSH_OPTS /tmp/codex/github_token.txt "$SSH_USER@$PUBLIC_IP:$REMOTE_WORKDIR/.github/tmp/"

          # Run pipeline on EC2
          ssh $SSH_OPTS "$SSH_USER@$PUBLIC_IP" "REMOTE_WORKDIR=$REMOTE_WORKDIR PR_NUMBER='$PR_NUMBER' bash -s" <<'REMOTE_SCRIPT'
          set -euo pipefail
          cd "$REMOTE_WORKDIR"

          # Parse PR metadata
          python3 - <<'PY' > .github/tmp/pr_meta.sh
          import json
          from pathlib import Path
          ctx = json.loads(Path(".github/tmp/github_context.json").read_text())
          event = ctx.get("event") or {}
          pr = event.get("pull_request") or {}
          owner_repo = ctx.get("repository") or ""
          pr_number = pr.get("number") or event.get("number") or ""
          base_ref = (pr.get("base") or {}).get("ref") or "dev"
          head_sha = (pr.get("head") or {}).get("sha") or ""
          print(f'OWNER_REPO="{owner_repo}"')
          print(f'PR_NUMBER="{pr_number}"')
          print(f'BASE_REF="{base_ref}"')
          print(f'HEAD_SHA="{head_sha}"')
          PY
          source .github/tmp/pr_meta.sh

          # Clone repo
          TOKEN="$(cat .github/tmp/github_token.txt)"
          CLONE_URL="https://x-access-token:${TOKEN}@github.com/${OWNER_REPO}.git"
          [[ -d repo/.git ]] || git clone "$CLONE_URL" repo
          cd repo
          git remote set-url origin "$CLONE_URL"
          git fetch origin "$BASE_REF" --depth 50
          [[ -n "$PR_NUMBER" ]] && git fetch origin "pull/${PR_NUMBER}/head:pr-head" --depth 50 && git checkout pr-head
          git remote set-url origin "https://github.com/${OWNER_REPO}.git"

          # Run the pipeline script from repo
          chmod +x .github/codex/run_pipeline.sh
          REMOTE_WORKDIR="$REMOTE_WORKDIR" .github/codex/run_pipeline.sh
          REMOTE_SCRIPT
