name: dev-codex-cli-review

on:
  pull_request:
    branches: [dev]
    types: [opened, reopened, synchronize]
  pull_request_target:
    branches: [dev]
    types: [opened, reopened, synchronize]
  push:
    branches:
      - e2e-codex-review-*
  workflow_dispatch:
    inputs:
      pr_number:
        description: Pull request number to review
        required: true
        type: string

jobs:
  codex-cli:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      # Step 1: Checkout
      - uses: actions/checkout@v4

      # Step 2: Setup files and run pipeline
      - name: run-codex-review
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CODEX_AUTH_JSON: ${{ secrets.CODEX_AUTH_JSON || vars.CODEX_AUTH_JSON }}
          CODEX_ID_RSA: ${{ secrets.CODEX_ID_RSA || vars.CODEX_ID_RSA }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID || vars.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY || vars.AWS_SECRET_ACCESS_KEY }}
          CODEX_EXISTING_INSTANCE_ID: ${{ secrets.CODEX_EXISTING_INSTANCE_ID || vars.CODEX_EXISTING_INSTANCE_ID }}
          PR_NUMBER: ${{ github.event.inputs.pr_number || '' }}
          SESSION_NAME: codex-${{ github.event.repository.name }}-${{ github.run_id }}
        run: |
          set -euo pipefail

          # Write secrets to files
          mkdir -p .github/tmp
          echo "$GITHUB_CONTEXT" > .github/tmp/github_context.json
          echo "$GITHUB_TOKEN" > .github/tmp/github_token.txt
          echo "$CODEX_AUTH_JSON" > .github/tmp/auth.json
          echo "$CODEX_ID_RSA" > .github/tmp/id_rsa
          chmod 600 .github/tmp/id_rsa

          # Write .env for run_pipeline.sh
          cat > .env <<EOF
          AWS_ACCESS_KEY_ID='$AWS_ACCESS_KEY_ID'
          AWS_SECRET_ACCESS_KEY='$AWS_SECRET_ACCESS_KEY'
          CODEX_EXISTING_INSTANCE_ID='$CODEX_EXISTING_INSTANCE_ID'
          EOF

          # Export vars for run_pipeline.sh
          export PR_NUMBER
          export SESSION_NAME

          # Run the pipeline
          chmod +x .github/codex/run_pipeline.sh
          .github/codex/run_pipeline.sh
