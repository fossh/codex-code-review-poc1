direction: down

# Trigger Events
Trigger: {
  shape: sql_table
  pull_request: "pull_request to v2"
  workflow_dispatch: "workflow_dispatch"
}

# GitHub Actions Workflow
GHA: {
  shape: sql_table
  name: "codex-pr-review.yaml"
  steps: "checkout -> setup-uv -> init-db -> run_pipeline -> ssh-poweroff"
}

Trigger -> GHA

# Secrets
Secrets: {
  shape: sql_table
  GITHUB_TOKEN: "auto-provided by GitHub"
  CODEX_CONFIG: "ami_id, instance_type, key_name, security_group_id, region, ssh_private_key, aws_creds"
}

Secrets -> GHA

# Pipeline Scripts
Pipeline: {
  shape: sql_table
  name: "run_pipeline.py"
  order: "aws_launch_spot -> ssh_wait -> write_agents -> write_prompt -> rsync_to_ec2 -> ssh_run_codex"
}

aws_launch_spot: {
  shape: sql_table
  script: "aws_launch_spot.py"
  inputs: "ami_id, instance_type, key_name, security_group_id, region, aws_creds"
  outputs: "instance_id, public_ip"
}

ssh_wait: {
  shape: sql_table
  script: "ssh_wait.py"
  inputs: "public_ip, ssh_private_key"
  outputs: "(none)"
}

write_agents: {
  shape: sql_table
  script: "002_write_agents.py"
  inputs: "workdir, pr_number, dumps.github, dumps.github_token"
  outputs: "agents_md, file: AGENTS.md"
}

write_prompt: {
  shape: sql_table
  script: "003_write_prompt.py"
  inputs: "dumps.github"
  outputs: "prompt, file: prompt.txt"
}

rsync_to_ec2: {
  shape: sql_table
  script: "rsync_to_ec2.py"
  inputs: "public_ip, ssh_private_key, workdir"
  outputs: "AGENTS.md + prompt.txt synced to EC2"
}

ssh_run_codex: {
  shape: sql_table
  script: "ssh_run_codex.py"
  inputs: "public_ip, ssh_private_key, workdir"
  cmd: "cat prompt.txt | codex exec -m gpt-5.2-codex ..."
  outputs: "PR review posted to GitHub"
}

ssh_poweroff: {
  shape: sql_table
  script: "ssh_poweroff.py"
  inputs: "public_ip, ssh_private_key"
  outputs: "EC2 instance powered off"
}

GHA -> Pipeline
Pipeline -> aws_launch_spot -> ssh_wait -> write_agents -> write_prompt
write_prompt -> rsync_to_ec2 -> ssh_run_codex
GHA -> ssh_poweroff

# SQLite DB
DB: {
  shape: sql_table
  path: ".github/tmp/pipeline.db"
  config_table: "workdir, pr_number, repo, ami_id, instance_type, key_name, security_group_id, region, ssh_private_key, aws_creds, instance_id, public_ip, prompt, agents_md"
  dumps_table: "github (json), github_token"
}

GHA -> DB: "init-db creates"

# EC2 Directory
EC2_Dir: {
  shape: sql_table
  pattern: "/home/ubuntu/{repo_name}/{pr_number}/"
  uploaded: "AGENTS.md, prompt.txt"
}

rsync_to_ec2 -> EC2_Dir

# Codex Actions
Codex: {
  shape: sql_table
  step1: "Reads AGENTS.md"
  step2: "Clones repo & checkouts PR"
  step3: "Reviews diff"
  step4: "POSTs review to GitHub API"
}

ssh_run_codex -> Codex

# Final Output
PR_Review: {
  shape: sql_table
  output: "Review posted on PR"
}

Codex -> PR_Review
