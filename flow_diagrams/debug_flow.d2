direction: down

# Debug/Local Testing Flow

title: "Debug Flow" {
  style.fill: "#f0f0f0"
}

# Trigger
trigger: "workflow_dispatch (manual)" {
  style.fill: "#e0e0e0"
}

# Dump Workflow - same instance lifecycle as prod but sleep instead of codex
dump_workflow: "dump-pr-context.yaml" {
  style.fill: "#e8f4f8"
  checkout -> setup-uv -> init-db -> run-debug-pipeline -> ssh-poweroff
}

trigger -> dump_workflow

# Debug Pipeline (like prod but sleep instead of codex)
Pipeline: "run_debug_pipeline.py" {
  style.fill: "#f8f9fa"

  aws_launch_spot: {
    shape: sql_table
    script: "aws_launch_spot.py"
    inputs: "ami_id, instance_type, key_name, security_group_id, region, aws_creds"
    outputs: "instance_id, public_ip"
    state: "EC2 spot instance running"
  }

  ssh_wait: {
    shape: sql_table
    script: "ssh_wait.py"
    inputs: "public_ip, ssh_private_key"
    outputs: "(none)"
    state: "EC2 SSH ready"
  }

  write_agents: {
    shape: sql_table
    script: "002_write_agents.py"
    inputs: "workdir, pr_number, dumps.github, dumps.github_token"
    outputs: "agents_md, file: AGENTS.md"
    state: "AGENTS.md created locally"
  }

  write_prompt: {
    shape: sql_table
    script: "003_write_prompt.py"
    inputs: "dumps.github"
    outputs: "prompt"
    state: "prompt.txt created locally"
  }

  rsync_to_ec2: {
    shape: sql_table
    script: "rsync_to_ec2.py"
    inputs: "public_ip, ssh_private_key, workdir"
    outputs: "(none)"
    state: "AGENTS.md + prompt.txt synced to EC2 workdir"
  }

  sleep_6h: {
    shape: sql_table
    script: "(inline bash)"
    inputs: "(none)"
    outputs: "(none)"
    cmd: "sleep 21600"
    state: "GitHub token kept active for 6 hours"
  }

  aws_launch_spot -> ssh_wait -> write_agents -> write_prompt
  write_prompt -> rsync_to_ec2 -> sleep_6h
}

dump_workflow.run-debug-pipeline -> Pipeline

# SSH Poweroff (separate step)
ssh_poweroff: {
  shape: sql_table
  script: "ssh_poweroff.py"
  inputs: "public_ip, ssh_private_key"
  outputs: "(none)"
  state: "EC2 instance powered off"
}

dump_workflow.ssh-poweroff -> ssh_poweroff

# EC2 Directory
EC2_Dir: "EC2 Directory" {
  style.fill: "#ff9900"
  workdir: "/home/ubuntu/{repo_name}/{pr_number}/"
  content: "AGENTS.md, prompt.txt, pipeline.db"
}

Pipeline.rsync_to_ec2 -> EC2_Dir: "uploads"

# Local Download
ec2_download: {
  shape: sql_table
  script: "rsync_from_ec2.py <repo> <pr>"
  inputs: "public_ip, ssh_private_key, workdir"
  outputs: ".github/tmp/pipeline.db"
  state: "Context downloaded locally"
}

EC2_Dir -> ec2_download: "download during 6h window"

# Local Testing
local_steps: "Local Testing" {
  style.fill: "#d4edda"

  instructions: {
    shape: sql_table
    step1: "1. Trigger dump-pr-context workflow"
    step2: "2. Run: uv run rsync_from_ec2.py <repo> <pr>"
    step3: "3. Run scripts locally: uv run .github/codex/{script}.py"
    step4: "4. Or run codex locally to test prompts"
  }
}

ec2_download -> local_steps
