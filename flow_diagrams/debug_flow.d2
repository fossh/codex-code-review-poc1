direction: down

# Debug/Local Testing Flow

# Trigger
Trigger: {
  shape: sql_table
  event: "workflow_dispatch (manual)"
  input: "pr_number"
}

# Dump Workflow
dump_workflow: {
  shape: sql_table
  name: "dump-pr-context.yaml"
  workflow_steps: "checkout -> setup-uv -> init-db -> run-debug-pipeline -> ssh-poweroff"
}

Trigger -> dump_workflow

# Debug Pipeline
Pipeline: {
  shape: sql_table
  name: "run_debug_pipeline.py"
  order: "aws_launch_spot -> ssh_wait -> write_agents -> write_prompt -> rsync_to_ec2 -> sleep_6h"
}

aws_launch_spot: {
  shape: sql_table
  script: "aws_launch_spot.py"
  inputs: "ami_id, instance_type, key_name, security_group_id, region (ap-south-1), aws_creds"
  outputs: "instance_id, public_ip"
}

ssh_wait: {
  shape: sql_table
  script: "ssh_wait.py"
  inputs: "public_ip, ssh_private_key"
  outputs: "(none)"
}

write_agents: {
  shape: sql_table
  script: "002_write_agents.py"
  inputs: "workdir, pr_number, dumps.github, dumps.github_token"
  outputs: "agents_md, file: AGENTS.md"
}

write_prompt: {
  shape: sql_table
  script: "003_write_prompt.py"
  inputs: "dumps.github"
  outputs: "prompt, file: prompt.txt"
}

rsync_to_ec2: {
  shape: sql_table
  script: "rsync_to_ec2.py"
  inputs: "public_ip, ssh_private_key, workdir, codex_auth_json"
  outputs: "AGENTS.md, prompt.txt -> workdir; auth.json -> ~/.codex/"
}

sleep_6h: {
  shape: sql_table
  script: "(inline in run_debug_pipeline.py)"
  cmd: "time.sleep(21600)"
  purpose: "Keep GitHub token active for local testing"
}

ssh_poweroff: {
  shape: sql_table
  script: "ssh_poweroff.py"
  condition: "if: always()"
  inputs: "public_ip, ssh_private_key"
  outputs: "EC2 instance powered off"
}

dump_workflow -> Pipeline
Pipeline -> aws_launch_spot -> ssh_wait -> write_agents -> write_prompt
write_prompt -> rsync_to_ec2 -> sleep_6h
dump_workflow -> ssh_poweroff

# EC2 Instance (pre-baked AMI)
EC2: {
  shape: sql_table
  ami: "ami-02f6ef44bfbfd81b1 (Mumbai)"
  baked_in: "codex CLI"
  workdir: "/home/ubuntu/{repo_name}/{pr_number}/"
  rsynced_workdir: "AGENTS.md, prompt.txt"
  rsynced_home: "~/.codex/auth.json"
}

rsync_to_ec2 -> EC2

# Local Download
rsync_from_ec2: {
  shape: sql_table
  script: "rsync_from_ec2.py <ip> <repo> <pr>"
  inputs: "public_ip, ssh_private_key, workdir"
  outputs: ".github/tmp/ (AGENTS.md, prompt.txt)"
}

EC2 -> rsync_from_ec2: "download during 6h window"

# Local Testing Instructions
local_testing: {
  shape: sql_table
  step1: "1. Trigger dump-pr-context workflow"
  step2: "2. Copy EC2 IP from workflow logs"
  step3: "3. Run: uv run rsync_from_ec2.py <ip> <repo> <pr>"
  step4: "4. Test scripts locally or run codex manually"
}

rsync_from_ec2 -> local_testing
