flowchart TD
    subgraph Trigger["Trigger Events"]
        T1["pull_request to v2"]
        T2["workflow_dispatch"]
    end

    T1 --> GHA
    T2 --> GHA

    subgraph GHA["codex-pr-review.yaml"]
        subgraph Permissions["permissions"]
            P1["contents: read"]
            P2["pull-requests: write"]
        end

        subgraph Steps["Steps"]
            A["checkout"]
            B["dump-context-to-sqlite"]
            C["setup-uv"]
            D["setup-codex (npm)"]
            E["run-pipeline"]
        end

        A --> B --> C --> D --> E
    end

    subgraph Secrets["GitHub Secrets"]
        S1["GITHUB_TOKEN (auto)"]
        S2["OPENAI_API_KEY"]
    end

    S1 --> B
    S2 --> E

    subgraph DB["pipeline.db"]
        subgraph DumpsTable["dumps table"]
            D1["json, github"]
            D2["json, event"]
            D3["secret, github_token"]
        end
        subgraph ConfigTable["config table"]
            C1["repo_root"]
            C2["pr_number"]
        end
    end

    B --> DumpsTable
    B --> ConfigTable

    subgraph Templates["Jinja2 Templates"]
        J1["agents.md.j2"]
        J2["prompt.txt.j2"]
    end

    subgraph Scripts["Python Scripts (run-pipeline)"]
        subgraph S2["002_write_agents.py"]
            S2_read["reads: github, token, pr_number"]
            S2_render["renders: agents.md.j2"]
            S2_write["writes: AGENTS.md with API details"]
        end

        subgraph S3["003_write_prompt.py"]
            S3_read["reads: github context"]
            S3_render["renders: prompt.txt.j2"]
            S3_write["writes: prompt to config"]
        end

        subgraph S4["004_run_codex.py"]
            S4_read["reads: repo_root, prompt"]
            S4_cmd["codex exec -m gpt-5.2-codex"]
        end
    end

    J1 --> S2_render
    J2 --> S3_render

    E --> S2
    S2 --> S3
    S3 --> S4

    subgraph CodexDoes["Codex Handles Everything"]
        CD1["Reads AGENTS.md"]
        CD2["Reviews git diff"]
        CD3["POSTs review to GitHub API"]
    end

    S4 --> CodexDoes
    CodexDoes --> GitHub["GitHub API"]
    GitHub --> PR["Review on PR"]

    subgraph DebugWorkflow["dump-pr-context.yaml (debug)"]
        DW1["manual trigger only"]
        DW2["dumps context to SQLite"]
        DW3["uploads pipeline.db artifact"]
    end
